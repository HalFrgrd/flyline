ARG UBUNTU_VERSION

# Stage 1: Builder - Build the Flyline shared library
FROM flyline_built_library

# Stage 2: Ubuntu Testing - Test the built library on specified Ubuntu version
FROM ubuntu:${UBUNTU_VERSION} AS ubuntu_testing

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install basic dependencies and bash
RUN apt-get update && apt-get install -y \
    bash \
    binutils \
    && rm -rf /var/lib/apt/lists/*

# Set up working directory
WORKDIR /flyline

# Copy the built shared library from builder stage
COPY --from=flyline_built_library /libflyline.so .

# Copy test_bashrc.sh as .bashrc
COPY tests/docker_integration_tests/test_bashrc.sh /root/.bashrc

# Make sure the built library is accessible
ENV LD_LIBRARY_PATH="/usr/local/lib:${LD_LIBRARY_PATH}"

# Default command to run the test
CMD ["/bin/bash", "-i", "-c", "flyline -s && flyline -v && echo 'SUCCESS: Test completed'"]

