# Common Ubuntu test template
# Can be used with different Ubuntu versions via build args
# Usage: docker build --build-arg UBUNTU_VERSION=20.04 -f Dockerfile.ubuntu.template -t flyline-test-ubuntu2004 .
ARG UBUNTU_VERSION=22.04
FROM ubuntu:${UBUNTU_VERSION}

# Metadata
LABEL description="Flyline test container for Ubuntu ${UBUNTU_VERSION}"
LABEL ubuntu.version="${UBUNTU_VERSION}"

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install basic dependencies and bash (no need for Rust/build tools)
RUN apt-get update && apt-get install -y \
    bash \
    && rm -rf /var/lib/apt/lists/*

# Set up working directory
WORKDIR /flyline

# Copy the pre-built shared library (built with glibc 2.31 compatibility)
COPY libflyline-glibc231.so /usr/local/lib/libflyline.so

# Copy test_rc.sh as .bashrc
COPY tests/docker_integration_tests/test_rc.sh /root/.bashrc

# Make sure the built library is accessible
ENV LD_LIBRARY_PATH="/usr/local/lib:${LD_LIBRARY_PATH}"

# Set bash as the shell and make it interactive
SHELL ["/bin/bash", "-i", "-c"]

# Default command to run the test
CMD ["/bin/bash", "-i", "-c", "flyline -s && exit"]